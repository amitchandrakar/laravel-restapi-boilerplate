#!/bin/sh

# Fix the path to ensure we can find composer
export PATH=$PATH:/usr/local/bin:/usr/local/sbin:/opt/homebrew/bin

echo "ğŸ” Running pre-commit checks..."

# 1. Auto-format with Prettier
echo "âœ¨ Running Prettier (Auto-format)..."
npm run format
STATUS=$?

if [ $STATUS -ne 0 ]; then
    echo "âŒ Prettier formatting failed!"
    exit 1
fi

# 2. Auto-format with Pint
echo "ğŸ¨ Running Pint (Auto-format)..."
composer format
STATUS=$?

if [ $STATUS -ne 0 ]; then
    echo "âŒ Pint formatting failed!"
    exit 1
fi

# 3. Verify with Pint lint check
echo "ğŸ” Verifying code style with Pint..."
composer lint
STATUS=$?

if [ $STATUS -ne 0 ]; then
    echo "âŒ Pint verification failed!"
    echo "ğŸ’¡ This shouldn't happen after auto-format. Please review the errors."
    exit 1
fi

# 4. Check Static Analysis (Larastan)
echo "ğŸ§  Running Larastan (Static Analysis)..."
composer analyse
STATUS=$?

if [ $STATUS -ne 0 ]; then
    echo "âŒ Larastan check failed!"
    echo "ğŸ’¡ Please fix the errors reported above."
    exit 1
fi

# 5. Check Tests
echo "ğŸ§ª Running Tests..."
php artisan test
STATUS=$?

if [ $STATUS -ne 0 ]; then
    echo "âŒ Tests failed!"
    exit 1
fi

echo "âœ… All checks passed! Committing..."
exit 0
